<?php

/**
 * @file
 * Tests for ug_profile.module.
 */

/**
 * Test UG Profile feature.
 */
class UGProfileTestCase extends DrupalWebTestCase {

  public static function getInfo() {
    return array(
      'name' => 'UG Profile',
      'description' => 'Test the UG Profile feature.',
      'group' => 'UG',
    );
  }

  function setUp() {
    $this->profile = 'ug';
    parent::setUp('ug_profile', 'ug_profile_layouts');
  }

  /**
   * Test PP1 - Listing page for multiple profiles
   */
  function testListingPage() {
    $node = array();
    $node['type'] = 'profile';
    $node['field_profile_name'][LANGUAGE_NONE][0]['value'] = $this->randomName(8);
    $node['field_profile_lastname'][LANGUAGE_NONE][0]['value'] = $this->randomName(8);
    $node['field_profile_title'][LANGUAGE_NONE][0]['value'] = $this->randomName(16);
    $this->drupalCreateNode($node);
    $this->drupalGet('people');
    $this->assertText($node['field_profile_title'][LANGUAGE_NONE][0]['value']);

    $pattern = "//button[@name='']";
    $elements = $this->xpath($pattern);
    $this->assertTrue(empty($elements), 'The filter button does not have empty name attribute.');
  }

  /**
   * Test node title
   */
  function testNodeTitle() {
    $name = $this->randomName(8);
    $last = "O'".$this->randomName(8); // Last name with apostrophe.
    $title = $name . " " . $last;
    $settings = array();
    $settings['type'] = 'profile';
    $settings['field_profile_name'][LANGUAGE_NONE][0]['value'] = $name;
    $settings['field_profile_lastname'][LANGUAGE_NONE][0]['value'] = $last;
    $node = $this->drupalCreateNode($settings);
    $this->drupalGet('node/'.$node->nid);
    $this->assertText($title);
  }

  /**
   * Test uninstall hook behaviour.
   */
  function testHookUninstall() {
    /* Assert content type exists. */
    $this->assertTrue(node_type_get_type('profile'));
    /* Assert custom field exists (assume the rest are there). */
    $this->assertNotNull(field_info_field('field_profile_address'));    
    /* Disable and uninstall the feature. */
    module_disable(array('ug_profile', 'ug_profile_layouts'));
    drupal_uninstall_modules(array('ug_profile', 'ug_profile_layouts'));
    /* Assert profile type has been removed. */
    $this->assertFalse(node_type_get_type('profile'));
    /* Assert custom field has been deleted. */
    $this->assertNull(field_info_field('field_profile_address'));
  }

}

